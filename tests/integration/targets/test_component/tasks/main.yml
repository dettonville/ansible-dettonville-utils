---

- name: "Prepare test environment"
  include_tasks: prepare.yml

- name: Display other key test env data
  debug:
    msg:
      - "ansible_python={{ ansible_python }}"
      - "__dict_ordered_keys_supported={{__dict_ordered_keys_supported}}"

- name: "Set __test_component__test_case_id_list"
  set_fact:
    __test_component__test_case_id_list: "{{ test_component__test_case_id_list | d([]) }}"

- name: "Initialize __test_component__test_case_id_list"
  set_fact:
    __test_component__test_case_id_list_patterns: ".*"

- name: "Set __test_component__test_case_id_list"
  when: __test_component__test_case_id_list|length>0
  set_fact:
    __test_component__test_case_id_list_patterns: "{{ __test_component__test_case_id_list | join('|') }}"

- name: "Display __test_component__test_case_id_list"
  debug:
    var: __test_component__test_case_id_list

- name: "Display __test_component__test_case_id_list_patterns"
  debug:
    var: __test_component__test_case_id_list_patterns

- name: "Find test case variable data"
  find:
    paths: "{{ role_path }}/vars/{{ __test_component }}"
    file_type: "file"
    patterns: 'testdata.*({{ __test_component__test_case_id_list_patterns }}).*\.yml'
    recurse: yes
    follow: yes
    use_regex: true
  register: __test_component__test_var_files

- name: "Display __test_component__test_var_files"
  debug:
    var: __test_component__test_var_files
    verbosity: 2

- name: "Set __test_component__test_var_file_paths"
  set_fact:
    __test_component__test_var_file_paths: "{{ __test_component__test_var_files.files | map(attribute='path') | list | sort }}"

- name: "Display __test_component__test_var_file_paths"
  debug:
    var: __test_component__test_var_file_paths

- name: "Run component tests from specified list"
  include_tasks: run-component-test.yml
  loop: "{{ __test_component__test_var_file_paths }}"
  loop_control:
    loop_var: __test_component__test_case_var_file
